# 玩玩 duckdb

## duckdb 安装与启动

直接去官网下载[DuckDB Installation](https://duckdb.org/docs/installation/?version=stable&environment=cli&platform=linux&download_method=direct&architecture=x86_64)，下载下来就一个压缩包，解压到目录下就一个duckdb的
可执行文件。

### windows 
```shell
### Windows power shell
PS F:\> cd C:\Users\27528
PS C:\Users\27528> wget https://github.com/duckdb/duckdb/releases/download/v1.2.1/duckdb_cli-windows-amd64.zip -O duckdb_cli-windows-amd64.zip
PS C:\Users\27528> ls .\duckdb_cli-windows-amd64.zip


    目录: C:\Users\27528


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         2025/3/16     18:42       10312942 duckdb_cli-windows-amd64.zip
```

### Linux
没啥好说的，下载，解压即可。

### duckdb 初体验

1. 启动duckdb，并查看帮助。
```shell
# 1. 不带任何参数启动，默认为内存数据库
[jack@dev5 duckdb]$ pwd
/home/jack/Runtime/duckdb
[jack@dev5 duckdb]$ ./duckdb
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
Connected to a transient in-memory database.
Use ".open FILENAME" to reopen on a persistent database.
D .help
...

# 1.1 进入console后，使用ctrl+d退出

# 2.指定数据库文件，创建/home/jack/Runtime/duckdb/db/peanotes数据库，数据不会丢失
[jack@dev5 duckdb]$ mkdir -pv /home/jack/Runtime/duckdb/db/peanotes
mkdir: created directory '/home/jack/Runtime/duckdb/db/peanotes'

[jack@dev5 duckdb]$ ./duckdb /home/jack/Runtime/duckdb/db/peanotes/main
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
D .help
.bail on|off             Stop after hitting an error.  Default OFF
...
```

2. 使用sql,创建表，以及初始化数据, 这里测试发现，插入1亿条数据的时间大概20s左右。
参考[数据库脚本](./generate-test-data.sql)

```shell
[jack@dev5 duckdb]$ ./duckdb /home/jack/Runtime/duckdb/db/peanotes/main
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
D CREATE SEQUENCE IF NOT EXISTS seq_t_order_id START 1 ;
D CREATE TABLE t_order
  (
    id             bigint PRIMARY KEY DEFAULT nextval('seq_t_order_id'),
    sequence_no    VARCHAR(64) NOT NULL,
    customer_id    INTEGER     NOT NULL,
    product_id     INTEGER     NOT NULL,
    value_date     DATE,
    price          DECIMAL,
    quality        INTEGER     NOT NULL,
    value          DECIMAL,
    create_dt      TIMESTAMP,
    last_update_dt TIMESTAMP
  );
D
D insert into t_order (sequence_no, customer_id, product_id, value_date, price, quality, value, create_dt, last_update_dt)
  select gen_random_uuid()
       ,  cast(trunc(random() * 1000) as integer)
       ,  cast(trunc(random() * 10000) as integer)
       ,  date_add(current_date(), cast(trunc(random() * 1000) as integer))
       ,  round(random() * 1000000, 2)
       ,  cast(trunc(random() * 100000) as integer)
       ,  round(random() * 100000000, 2)
       ,  current_localtimestamp()
       ,  current_localtimestamp()
  from range(1,100000001);
100% ▕████████████████████████████████████████████████████████████▏

select count(0) from t_order;
D
D select count(0) from t_order;
┌──────────────────┐
│     count(0)     │
│      int64       │
├──────────────────┤
│    100000000     │
│ (100.00 million) │
└──────────────────┘
D
```

### 体验一下duckdb的查询性能,感受一下强大

1. 简单的聚合查询，性能很强，时间划费不超过1s.
```shell
D select customer_id, count(0), sum(value) from t_order group by customer_id;
┌─────────────┬──────────┬───────────────────┐
│ customer_id │ count(0) │   sum("value")    │
│    int32    │  int64   │   decimal(38,3)   │
├─────────────┼──────────┼───────────────────┤
│           0 │   100536 │ 5019380372101.460 │
│           1 │    99440 │ 4947693717189.180 │
│           2 │   100202 │ 5004071748648.090 │
│           3 │    99882 │ 4996218974616.040 │
│           4 │    99858 │ 4995873536283.190 │
│           5 │   100235 │ 5014901016697.150 │
│           6 │   100321 │ 5020278599721.410 │
│           7 │    99194 │ 4965318079415.320 │
│           8 │   100106 │ 5009659578836.530 │
│           9 │   100177 │ 5005206874299.410 │
│          10 │    99995 │ 5007748829987.550 │
│          11 │    99826 │ 4978113833987.550 │
│          12 │    99391 │ 4959552593570.240 │
│          13 │    99886 │ 4999395862994.770 │
│          14 │   100159 │ 5000966069387.820 │
│          15 │    99589 │ 5006355426723.750 │
│          16 │   100114 │ 4997588843189.030 │
│          17 │    99655 │ 4992722460082.410 │
│          18 │   100061 │ 5017893893604.650 │
│          19 │   100374 │ 5019596408311.770 │
│           · │      ·   │         ·         │
│           · │      ·   │         ·         │
│           · │      ·   │         ·         │
│         980 │   100036 │ 5006000204626.970 │
│         981 │   100169 │ 5003935432127.530 │
│         982 │    99672 │ 4980773551627.200 │
│         983 │    99905 │ 5005641740466.720 │
│         984 │    99713 │ 4974421223957.190 │
│         985 │    99987 │ 4997005063821.890 │
│         986 │   100248 │ 5008521365996.900 │
│         987 │    99664 │ 4979330329168.650 │
│         988 │    99539 │ 4968389244342.940 │
│         989 │    99532 │ 4967371062172.090 │
│         990 │   100311 │ 5003799158616.890 │
│         991 │    99433 │ 4972736337974.110 │
│         992 │    99692 │ 4979909268546.710 │
│         993 │    99713 │ 4988032175919.790 │
│         994 │    99826 │ 4993439448158.740 │
│         995 │    99791 │ 4960914230616.610 │
│         996 │   100671 │ 5037952512703.740 │
│         997 │    99637 │ 4982361369161.810 │
│         998 │    99849 │ 4996342998118.200 │
│         999 │    99894 │ 5001046743225.480 │
├─────────────┴──────────┴───────────────────┤
│ 1000 rows (40 shown)             3 columns │
└────────────────────────────────────────────┘
D

```

2. 带条件的查询,性能基本没什么损失，不超过1s
```shell
D select customer_id, count(0), sum(value) from t_order where price between 1 and 100  and value_date < '2025-05-01' group by customer_id;
┌─────────────┬──────────┬───────────────┐
│ customer_id │ count(0) │ sum("value")  │
│    int32    │  int64   │ decimal(38,3) │
├─────────────┼──────────┼───────────────┤
│           1 │        1 │  85204379.020 │
│           7 │        2 │ 118126447.610 │
│           8 │        1 │  35142722.700 │
│          13 │        1 │  96330599.290 │
│          14 │        2 │  44122515.990 │
│          17 │        1 │  48159331.050 │
│          18 │        1 │  58157164.950 │
│          20 │        1 │  46629750.300 │
│          23 │        2 │  18659294.920 │
│          27 │        2 │ 104639549.770 │
│          29 │        1 │  16382160.080 │
│          30 │        1 │  19413607.550 │
│          34 │        1 │  81546771.310 │
│          39 │        1 │  27923904.200 │
│          43 │        1 │  99380122.670 │
│          45 │        1 │  17025571.700 │
│          47 │        1 │   6807771.930 │
│          49 │        1 │  23775921.520 │
│          52 │        1 │  38023300.270 │
│          54 │        1 │  17251676.190 │
│           · │        · │        ·      │
│           · │        · │        ·      │
│           · │        · │        ·      │
│         942 │        1 │  45450349.690 │
│         943 │        2 │ 122078167.950 │
│         945 │        1 │  54509758.070 │
│         946 │        1 │  81560948.850 │
│         951 │        1 │  20171720.990 │
│         953 │        1 │  88276241.090 │
│         955 │        1 │  89560542.320 │
│         961 │        1 │  51396459.180 │
│         962 │        1 │  98661577.020 │
│         970 │        1 │  74278038.710 │
│         972 │        1 │  31903825.030 │
│         975 │        1 │  66980698.220 │
│         980 │        1 │  77387293.280 │
│         983 │        1 │  24660631.710 │
│         985 │        1 │  54233534.800 │
│         993 │        1 │  83369202.960 │
│         994 │        1 │  79299781.120 │
│         996 │        1 │  45111226.850 │
│         998 │        1 │  69130461.540 │
│         999 │        2 │  96647984.850 │
├─────────────┴──────────┴───────────────┤
│ 356 rows (40 shown)          3 columns │
└────────────────────────────────────────┘

D select customer_id, count(0), sum(value) from t_order where price between 1 and 100  and value_date = '2025-05-01' group by customer_id;
┌─────────────┬──────────┬───────────────┐
│ customer_id │ count(0) │ sum("value")  │
│    int32    │  int64   │ decimal(38,3) │
├─────────────┼──────────┼───────────────┤
│          93 │        1 │  27324750.500 │
│         179 │        1 │  95518637.970 │
│         477 │        1 │  68592557.110 │
│         631 │        1 │  55742825.730 │
│         633 │        1 │  88198221.560 │
│         908 │        1 │  18370674.140 │
└─────────────┴──────────┴───────────────┘
D

D select customer_id, count(0), sum(value) from t_order where value_date between '2025-01-01' and '2029-01-01' and sequence_no like 'a%' group by customer_id;
┌─────────────┬──────────┬──────────────────┐
│ customer_id │ count(0) │   sum("value")   │
│    int32    │  int64   │  decimal(38,3)   │
├─────────────┼──────────┼──────────────────┤
│           0 │     6237 │ 310155903832.470 │
│           1 │     6341 │ 317134127080.830 │
│           2 │     6308 │ 313788969971.390 │
│           3 │     6277 │ 315092018331.520 │
│           4 │     6201 │ 308842923059.070 │
│           5 │     6196 │ 310463032655.960 │
│           6 │     6277 │ 313962832934.250 │
│           7 │     6282 │ 316265983322.830 │
│           8 │     6106 │ 304220106130.380 │
│           9 │     6292 │ 312960934388.320 │
│          10 │     6371 │ 321496103351.770 │
│          11 │     6316 │ 312345129492.820 │
│          12 │     6211 │ 305911961168.790 │
│          13 │     6279 │ 316300257570.160 │
│          14 │     6272 │ 315460866958.810 │
│          15 │     6330 │ 318555997253.820 │
│          16 │     6177 │ 308212491457.880 │
│          17 │     6215 │ 311275123884.040 │
│          18 │     6306 │ 313360436870.190 │
│          19 │     6326 │ 314337297042.580 │
│           · │       ·  │         ·        │
│           · │       ·  │         ·        │
│           · │       ·  │         ·        │
│         980 │     6199 │ 311853427955.730 │
│         981 │     6257 │ 309767935290.930 │
│         982 │     6090 │ 303528190408.780 │
│         983 │     6281 │ 314856754717.130 │
│         984 │     6116 │ 305192776877.370 │
│         985 │     6284 │ 313738275123.670 │
│         986 │     6211 │ 306931096774.840 │
│         987 │     6281 │ 313694556142.020 │
│         988 │     6109 │ 307088742333.370 │
│         989 │     6284 │ 314824017397.270 │
│         990 │     6304 │ 313244166535.120 │
│         991 │     6195 │ 306931231037.810 │
│         992 │     6247 │ 310462372125.740 │
│         993 │     6221 │ 308203105037.020 │
│         994 │     6219 │ 311742597547.160 │
│         995 │     6410 │ 318573001488.790 │
│         996 │     6444 │ 324497043223.260 │
│         997 │     6126 │ 307534364007.430 │
│         998 │     6225 │ 313845672866.110 │
│         999 │     6164 │ 308034278263.980 │
├─────────────┴──────────┴──────────────────┤
│ 1000 rows (40 shown)            3 columns │
└───────────────────────────────────────────┘

```

### 体验数据导出
1. 导出为Parquet格式
```sql
copy t_order to '/home/jack/Runtime/duckdb/db/peanotes/order.parquet' (format 'parquet');
```
测试发现导出时间花费10s以内,可以直接查询外部的parquet文件，验证数据量是否匹配, 也可以直接查询文件。
```shell
D copy t_order to '/home/jack/Runtime/duckdb/db/peanotes/order.parquet' (format 'parquet');
100% ▕████████████████████████████████████████████████████████████▏
D
D select count(*) from '/home/jack/Runtime/duckdb/db/peanotes/order.parquet';
┌──────────────────┐
│   count_star()   │
│      int64       │
├──────────────────┤
│    100000000     │
│ (100.00 million) │
└──────────────────┘

D select customer_id, count(0), sum(value) from '/home/jack/Runtime/duckdb/db/peanotes/order.parquet'
  where value_date between '2025-01-01' and '2029-01-01' and sequence_no like 'a%' group by customer_id;
┌─────────────┬──────────┬──────────────────┐
│ customer_id │ count(0) │   sum("value")   │
│    int32    │  int64   │  decimal(38,3)   │
├─────────────┼──────────┼──────────────────┤
│           0 │     6237 │ 310155903832.470 │
│           1 │     6341 │ 317134127080.830 │
│           2 │     6308 │ 313788969971.390 │
│           3 │     6277 │ 315092018331.520 │
│           4 │     6201 │ 308842923059.070 │
│           5 │     6196 │ 310463032655.960 │
│           6 │     6277 │ 313962832934.250 │
│           7 │     6282 │ 316265983322.830 │
│           8 │     6106 │ 304220106130.380 │
│           9 │     6292 │ 312960934388.320 │
│          10 │     6371 │ 321496103351.770 │
│          11 │     6316 │ 312345129492.820 │
│          12 │     6211 │ 305911961168.790 │
│          13 │     6279 │ 316300257570.160 │
│          14 │     6272 │ 315460866958.810 │
│          15 │     6330 │ 318555997253.820 │
│          16 │     6177 │ 308212491457.880 │
│          17 │     6215 │ 311275123884.040 │
│          18 │     6306 │ 313360436870.190 │
│          19 │     6326 │ 314337297042.580 │
│           · │       ·  │         ·        │
│           · │       ·  │         ·        │
│           · │       ·  │         ·        │
│         980 │     6199 │ 311853427955.730 │
│         981 │     6257 │ 309767935290.930 │
│         982 │     6090 │ 303528190408.780 │
│         983 │     6281 │ 314856754717.130 │
│         984 │     6116 │ 305192776877.370 │
│         985 │     6284 │ 313738275123.670 │
│         986 │     6211 │ 306931096774.840 │
│         987 │     6281 │ 313694556142.020 │
│         988 │     6109 │ 307088742333.370 │
│         989 │     6284 │ 314824017397.270 │
│         990 │     6304 │ 313244166535.120 │
│         991 │     6195 │ 306931231037.810 │
│         992 │     6247 │ 310462372125.740 │
│         993 │     6221 │ 308203105037.020 │
│         994 │     6219 │ 311742597547.160 │
│         995 │     6410 │ 318573001488.790 │
│         996 │     6444 │ 324497043223.260 │
│         997 │     6126 │ 307534364007.430 │
│         998 │     6225 │ 313845672866.110 │
│         999 │     6164 │ 308034278263.980 │
├─────────────┴──────────┴──────────────────┤
│ 1000 rows (40 shown)            3 columns │
└───────────────────────────────────────────┘q
```

2. 导出为csv格式


### 体验数据从parquet文件导入
这里假如是有parquet文件，导入到jvm为宿主的duckdb里面.

```sql
INSERT INTO t_order
    SELECT * FROM read_parquet('test.parquet');
```
